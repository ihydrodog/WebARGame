# 보물 발견 로직 상세 분석

## 1. 현재 구현 요약

| 구분 | 구현 내용 | 비고 |
|------|-----------|------|
| **트리거** | 사용자가 "보물 발견!" 버튼 클릭 | 실제 카메라/이미지 인식 없음 |
| **설정에서 저장되는 데이터** | `capturedImage`, `detectedObject`, `marker`, `riddle`, `hint` | 플레이에서 **미사용** |
| **AR.js / A-Frame** | index.html에 로드됨 | game.js에서 사용하지 않음 |

---

## 2. 플레이 흐름 (game.js)

### 2-1. AR 모드 진입

```
[게임 시작] → [AR 카메라 시작] 클릭
    → startARMode() 호출
```

**startARMode() 동작:**

1. `#ar-container`를 다음 HTML로 교체:
   - `<video id="ar-video">` (웹캠 스트림)
   - 오버레이: "보물 위치를 찾으면 화면을 터치하세요!"
   - **버튼 1개**: `id="btn-found"` → "보물 발견!"

2. `getUserMedia({ video: { facingMode: 'environment' } })` 로 후면 카메라 시작

3. **이벤트**: `#btn-found` 클릭 시 `onMarkerFound()` 호출

→ **어떤 이미지/마커/오브젝트도 검사하지 않음.** 버튼만 누르면 “발견” 처리.

### 2-2. 보물 발견 처리

```js
// game.js 212-214행
document.getElementById('btn-found').addEventListener('click', () => {
  onMarkerFound();
});
```

**onMarkerFound() (219-229행):**

1. `showToast('보물 발견! 🎁', 'success')`
2. `showParticles()` (파티클 이펙트)
3. `setTimeout(..., 500)` 후 **showRiddleModal()** 호출

→ 현재 찾아야 할 보물(`currentTreasureIndex`)의 수수께끼 모달 표시.

### 2-3. 수수께끼 이후

- **정답** → `handleAnswerSubmit()` → 보너스 점수, 1.5초 후 `proceedToNext()`
- **오답** → 토스트 + shake, 재도전

**proceedToNext():**

- `currentTreasureIndex++`
- 마지막 보물이면 → 성공 화면
- 아니면 → 다음 힌트 갱신, AR 영역을 다시 "다음 보물을 찾아보세요!" + "AR 카메라 시작" 버튼으로 리셋

---

## 3. 설정에서 저장되는 데이터 vs 플레이 사용 여부

| 필드 | 설정에서 저장 | 플레이(game.js)에서 사용 |
|------|----------------|---------------------------|
| `capturedImage` | ✅ (촬영 이미지 base64) | ❌ |
| `detectedObject` | ✅ (선택한 COCO 클래스, 예: `"refrigerator"`) | ❌ |
| `marker` | ✅ (patternUrl 등) | ❌ |
| `riddle` / `riddleId` | ✅ | ✅ (수수께끼 표시) |
| `hint` | ✅ | ✅ (힌트 표시) |

→ **보물을 “찾는” 기준은 없고, 버튼 클릭만으로 발견이 인정됨.**

---

## 4. 결론 및 개선 방향

**현재:**  
보물 발견 = **사용자가 “보물 발견!” 버튼을 누를 때만** 발생.  
카메라 영상, 촬영 이미지, 선택 오브젝트, 마커 전혀 사용하지 않음.

**가능한 개선:**

1. **COCO-SSD 기반 자동 발견**  
   플레이 중에도 실시간으로 `model.detect(ar-video)` 수행.  
   현재 보물의 `detectedObject`(예: `"refrigerator"`)가 일정 신뢰도(예: 0.7) 이상으로 검출되면 `onMarkerFound()` 자동 호출.

2. **AR.js 마커/NFT**  
   `marker.patternUrl` / NFT 디스크립터로 A-Frame `<a-marker>` 또는 `<a-nft>` 사용,  
   `markerFound` / `nftMarkerFound` 이벤트에서 `onMarkerFound()` 호출.  
   (설정 시 캡처 이미지로 NFT 생성 파이프라인 필요)

3. **이미지 유사도**  
   캡처된 `capturedImage`와 현재 카메라 프레임을 비교해 유사도가 높을 때 발견 처리.  
   (구현 복잡도·성능 부담 있음)

현재 코드 기준으로는 **1번(COCO-SSD + detectedObject)** 이 설정 데이터와 바로 연결되고 구현 부담이 적음.
